<!DOCTYPE HTML>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title>PetaMap - CartoDB highlighted map!</title>
    <link href="reset.css" rel="stylesheet" type="text/css" />
    <link href="style.css" rel="stylesheet" type="text/css" />
    <link rel="stylesheet" href="http://libs.cartocdn.com/cartodb.js/v3/3.12/themes/css/cartodb.css" /> 
  </head>
  <body>
    <div id="map"></div>

    <script type="infowindow/html" id="content-template">
      <div class="container">
        <div class="brand">
          <img src="logo.svg" alt="TePetoMap" width="100">
        </div>
        <div class="MapTitle">
          <h1>{{ title }}</h1>
          <p>BY <a href="http://{{ username }}.cartodb.com/"><strong>{{ username }}</strong></a></p>
        </div>
        <dl class="MapMetadata">
          <dt><strong>{{ mapviews }}</strong></dt>
          <dd>MAPVIEWS</dd>
          <dt><strong>{{ likes }}</strong></dt>
          <dd>LIKES</dd>
          <dt><strong>{{ lat }}ºN, {{ lon }}ºS</strong></dt>
          <dd>LOCATION</dd>
        </dl>
      </div>
    </script>

    <script src="http://libs.cartocdn.com/cartodb.js/v3/3.12/cartodb.js"></script>
    <script>
      // js
      function main() {
        var sql = new cartodb.SQL({ user: 'platform' });
        sql.execute("SELECT url,count FROM top_viz")
          .done(getMapData)
          .error(function(errors) {
            // errors contains a list of errors
            console.log("errors:" + errors);
          });
      }

      function getMapData(data) {
        var url = data.rows[0].url;
        var mapviews = data.rows[0].count;
        var username = url.split('.')[0].replace('https://', '');
        $.ajax({
          url: url,
          dataType: 'jsonp',
          success: function(r) {
            r.mapviews = mapviews;
            r.username = username;
            generateInfo(r);
            generateMap(r);
          }
        })
      }

      function generateInfo(d) {
        var template = Mustache.compile($('#content-template').html());
        $('body').append(
          template({
            title: d.title,
            description: d.description,
            username: d.username,
            mapviews: d.mapviews,
            likes: d.likes,
            lon: '',
            lat: ''
          })
        )
      }

      function generateMap(data) {
        var a = cartodb.createVis('map', data, { title: false, description: false, shared: false })
        .done(function(vis, layers) {
        })
        .error(function(err) {
          console.log(err);
        });
      }
 
      window.onload = main;
      // end
    </script>
  </body>
</html>
